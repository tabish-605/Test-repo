#!/bin/bash

# Create project structure
mkdir -p ecommerce-otel/{frontend,backend,collector,prometheus,grafana/provisioning/datasources}

# Frontend structure
mkdir -p ecommerce-otel/frontend/{components,lib,pages,public/images,styles}
mkdir -p ecommerce-otel/frontend/components/{layout,product,cart,checkout,search,ui}
mkdir -p ecommerce-otel/frontend/pages/{products,account,auth}

# Backend structure
mkdir -p ecommerce-otel/backend/routers
mkdir -p ecommerce-otel/backend/scripts

# Create Docker Compose file
cat > ecommerce-otel/docker-compose.yml <<'EOL'
version: '3.8'
services:
  frontend:
    build: ./frontend
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://backend:8000
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4318
    depends_on:
      backend:
        condition: service_healthy
      otel-collector:
        condition: service_started

  backend:
    build: ./backend
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql://postgres:password@postgres:5432/ecommerce
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4318
    depends_on:
      postgres:
        condition: service_healthy
      otel-collector:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000"]
      interval: 10s
      timeout: 5s
      retries: 5

  postgres:
    image: postgres:14
    environment:
      POSTGRES_DB: ecommerce
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 10

  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.60.0
    command: ["--config=/etc/otel-collector-config.yaml"]
    volumes:
      - ./collector/otel-collector-config.yaml:/etc/otel-collector-config.yaml
    ports:
      - "4317:4317"   # OTLP gRPC
      - "4318:4318"   # OTLP HTTP
      - "8889:8889"   # Prometheus metrics
    depends_on:
      jaeger:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--spider", "http://localhost:13133/"]
      interval: 5s
      timeout: 5s
      retries: 5

  jaeger:
    image: jaegertracing/all-in-one:1.40
    ports:
      - "16686:16686"

  prometheus:
    image: prom/prometheus:v2.36.0
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"

  grafana:
    image: grafana/grafana:9.0.2
    volumes:
      - ./grafana/provisioning:/etc/grafana/provisioning
    ports:
      - "3001:3000"
    environment:
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin

volumes:
  postgres-data:
EOL

# Create OTel Collector config
cat > ecommerce-otel/collector/otel-collector-config.yaml <<'EOL'
receivers:
  otlp:
    protocols:
      grpc:
        endpoint: "0.0.0.0:4317"
      http:
        endpoint: "0.0.0.0:4318"

exporters:
  jaeger:
    endpoint: "jaeger:14250"
    tls:
      insecure: true
  prometheus:
    endpoint: "0.0.0.0:8889"
    namespace: ecommerce
    const_labels:
      service: "ecommerce"
  logging:
    loglevel: debug

processors:
  batch:

service:
  pipelines:
    traces:
      receivers: [otlp]
      processors: [batch]
      exporters: [jaeger, logging]
    metrics:
      receivers: [otlp]
      processors: [batch]
      exporters: [prometheus, logging]
EOL

# Create Prometheus config
cat > ecommerce-otel/prometheus/prometheus.yml <<'EOL'
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'otel-collector'
    scrape_interval: 5s
    metrics_path: '/metrics'
    static_configs:
      - targets: ['otel-collector:8889']
EOL

# Create Grafana datasource config
mkdir -p ecommerce-otel/grafana/provisioning/datasources
cat > ecommerce-otel/grafana/provisioning/datasources/datasource.yml <<'EOL'
apiVersion: 1
datasources:
  - name: Prometheus
    type: prometheus
    access: proxy
    url: http://prometheus:9090
    isDefault: true
EOL

# Create DB init script
cat > ecommerce-otel/backend/scripts/init_db.sh <<'EOL'
#!/bin/bash
set -e

# Wait for PostgreSQL to start
until PGPASSWORD=password psql -h "postgres" -U "postgres" -c '\q'; do
  >&2 echo "Postgres is unavailable - sleeping"
  sleep 2
done

# Create tables and insert data
PGPASSWORD=password psql -h "postgres" -U "postgres" -d "ecommerce" <<-EOSQL
    CREATE TABLE IF NOT EXISTS products (
        id SERIAL PRIMARY KEY,
        name VARCHAR(100) NOT NULL,
        slug VARCHAR(100) UNIQUE NOT NULL,
        description TEXT,
        price FLOAT NOT NULL,
        category VARCHAR(50),
        image VARCHAR(200),
        rating FLOAT DEFAULT 0.0,
        review_count INTEGER DEFAULT 0,
        sizes VARCHAR(100)
    );
    
    INSERT INTO products (name, slug, description, price, category, image, rating, review_count, sizes) 
    VALUES 
    ('Wireless Bluetooth Headphones', 'wireless-bluetooth-headphones', 'Premium noise-cancelling wireless headphones', 129.99, 'electronics', 'https://via.placeholder.com/300', 4.5, 120, 'One Size'),
    ('Running Shoes', 'running-shoes', 'Lightweight running shoes with extra cushioning', 89.99, 'clothing', 'https://via.placeholder.com/300', 4.2, 85, 'S,M,L,XL'),
    ('Smart Watch', 'smart-watch', 'Track your fitness and stay connected', 199.99, 'electronics', 'https://via.placeholder.com/300', 4.7, 210, 'One Size'),
    ('Cotton T-Shirt', 'cotton-t-shirt', 'Comfortable everyday t-shirt', 24.99, 'clothing', 'https://via.placeholder.com/300', 4.0, 45, 'S,M,L,XL'),
    ('Desk Lamp', 'desk-lamp', 'Adjustable LED desk lamp', 39.99, 'home', 'https://via.placeholder.com/300', 4.3, 67, 'One Size')
    ON CONFLICT (slug) DO NOTHING;
EOSQL
EOL

chmod +x ecommerce-otel/backend/scripts/init_db.sh

# Create wait-for-it script
cat > ecommerce-otel/backend/wait-for-it.sh <<'EOL'
#!/bin/sh
host="$1"
port="$2"
shift 2
cmd="$@"

echo "Waiting for $host:$port..."
until nc -z "$host" "$port"; do
  sleep 2
done

echo "$host:$port is available - executing command"
exec $cmd
EOL

chmod +x ecommerce-otel/backend/wait-for-it.sh

# =============================
# FRONTEND FILES (FIXED)
# =============================

# Create Next.js config
cat > ecommerce-otel/frontend/next.config.js <<'EOL'
/** @type {import('next').NextConfig} */
module.exports = {
  reactStrictMode: true,
  images: {
    domains: ['via.placeholder.com'],
  },
  experimental: {
    instrumentationHook: true,
  },
  output: 'standalone',
}
EOL

# Create package.json
cat > ecommerce-otel/frontend/package.json <<'EOL'
{
  "name": "ecommerce-frontend",
  "version": "1.0.0",
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "css:build": "tailwindcss -i ./styles/globals.css -o ./public/tailwind.css --minify"
  },
  "dependencies": {
    "@opentelemetry/api": "^1.4.1",
    "@opentelemetry/auto-instrumentations-node": "^0.39.4",
    "@opentelemetry/exporter-trace-otlp-http": "^0.45.0",
    "@opentelemetry/sdk-node": "^0.45.0",
    "next": "13.4.12",
    "react": "18.2.0",
    "react-dom": "18.2.0",
    "react-icons": "^4.10.1"
  },
  "devDependencies": {
    "autoprefixer": "^10.4.14",
    "postcss": "^8.4.27",
    "tailwindcss": "^3.3.3"
  }
}
EOL

# Create Tailwind config
cat > ecommerce-otel/frontend/styles/tailwind.config.js <<'EOL'
/** @type {import('tailwindcss').Config} */
module.exports = {
  content: [
    "./pages/**/*.{js,ts,jsx,tsx}",
    "./components/**/*.{js,ts,jsx,tsx}",
  ],
  theme: {
    extend: {
      colors: {
        primary: {
          600: '#4f46e5',
          700: '#4338ca',
        },
      },
    },
  },
  plugins: [],
}
EOL

# Create global CSS
cat > ecommerce-otel/frontend/styles/globals.css <<'EOL'
@tailwind base;
@tailwind components;
@tailwind utilities;

html,
body {
  padding: 0;
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Oxygen,
    Ubuntu, Cantarell, Fira Sans, Droid Sans, Helvetica Neue, sans-serif;
}

* {
  box-sizing: border-box;
}
EOL

# Create tracing setup (FIXED ENDPOINT)
cat > ecommerce-otel/frontend/lib/tracing.js <<'EOL'
const opentelemetry = require('@opentelemetry/sdk-node');
const { getNodeAutoInstrumentations } = require('@opentelemetry/auto-instrumentations-node');
const { OTLPTraceExporter } = require('@opentelemetry/exporter-trace-otlp-http');

const sdk = new opentelemetry.NodeSDK({
  traceExporter: new OTLPTraceExporter({
    url: 'http://otel-collector:4318/v1/traces'
  }),
  instrumentations: [getNodeAutoInstrumentations()],
  serviceName: 'ecommerce-frontend'
});

sdk.start();
EOL

# Create API helper (FIXED ERROR HANDLING)
cat > ecommerce-otel/frontend/lib/api.js <<'EOL'
const API_BASE = process.env.NEXT_PUBLIC_API_URL || '';

const handleResponse = async (response) => {
  if (!response.ok) {
    const error = await response.text();
    throw new Error(error || 'Request failed');
  }
  return response.json();
};

export const fetchProducts = async () => {
  const response = await fetch(`${API_BASE}/api/products`);
  return handleResponse(response);
};

export const fetchProduct = async (slug) => {
  const response = await fetch(`${API_BASE}/api/products/${slug}`);
  return handleResponse(response);
};

export const addToCart = async (item) => {
  const response = await fetch(`${API_BASE}/api/cart`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(item)
  });
  return handleResponse(response);
};
EOL

# Create cart context
cat > ecommerce-otel/frontend/lib/cart.js <<'EOL'
import { createContext, useState, useEffect, useContext } from 'react';

const CartContext = createContext();

export function CartProvider({ children }) {
  const [cart, setCart] = useState([]);
  const [isCartOpen, setIsCartOpen] = useState(false);

  useEffect(() => {
    const savedCart = localStorage.getItem('cart');
    if (savedCart) {
      setCart(JSON.parse(savedCart));
    }
  }, []);

  useEffect(() => {
    localStorage.setItem('cart', JSON.stringify(cart));
  }, [cart]);

  const addToCart = (product) => {
    const existingItem = cart.find(item => 
      item.id === product.id && item.size === product.size
    );

    if (existingItem) {
      setCart(cart.map(item => 
        item.id === product.id && item.size === product.size
          ? { ...item, quantity: item.quantity + product.quantity }
          : item
      ));
    } else {
      setCart([...cart, product]);
    }
    setIsCartOpen(true);
  };

  const removeItem = (id, size) => {
    setCart(cart.filter(item => !(item.id === id && item.size === size)));
  };

  const updateQuantity = (id, size, quantity) => {
    if (quantity < 1) return;
    setCart(cart.map(item => 
      item.id === id && item.size === size
        ? { ...item, quantity }
        : item
    ));
  };

  const cartCount = cart.reduce((total, item) => total + item.quantity, 0);
  const cartTotal = cart.reduce((total, item) => total + (item.price * item.quantity), 0);

  return (
    <CartContext.Provider 
      value={{ 
        cart, 
        cartCount, 
        cartTotal, 
        isCartOpen, 
        setIsCartOpen,
        addToCart, 
        removeItem, 
        updateQuantity,
        clearCart: () => setCart([])
      }}
    >
      {children}
    </CartContext.Provider>
  );
}

export const useCart = () => useContext(CartContext);
EOL

# Create layout components
cat > ecommerce-otel/frontend/components/layout/Header.js <<'EOL'
import { useState } from 'react';
import Link from 'next/link';
import { useCart } from '../../lib/cart';
import CartIcon from './CartIcon';
import SearchBar from '../search/SearchBar';

const Header = () => {
  const { setIsCartOpen, cartCount } = useCart();
  
  return (
    <header className="bg-white shadow-md sticky top-0 z-50">
      <div className="container mx-auto px-4 py-4 flex items-center justify-between">
        <div className="flex items-center">
          <Link href="/">
            <a className="text-2xl font-bold text-indigo-700 flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" className="h-8 w-8 mr-2 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
              </svg>
              ShopNext
            </a>
          </Link>
        </div>

        <div className="hidden md:block flex-grow mx-8 max-w-xl">
          <SearchBar />
        </div>

        <nav className="hidden md:flex space-x-6">
          <Link href="/products">
            <a className="text-gray-700 hover:text-indigo-600 font-medium flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
              </svg>
              Shop
            </a>
          </Link>
          <Link href="/account/wishlist">
            <a className="text-gray-700 hover:text-indigo-600 font-medium flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
              </svg>
              Wishlist
            </a>
          </Link>
          <Link href="/account/orders">
            <a className="text-gray-700 hover:text-indigo-600 font-medium flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
              </svg>
              Orders
            </a>
          </Link>
        </nav>

        <div className="flex items-center space-x-4">
          <Link href="/auth/login">
            <a className="text-gray-700 hover:text-indigo-600 font-medium hidden md:block">
              Sign In
            </a>
          </Link>
          <button 
            onClick={() => setIsCartOpen(true)}
            className="relative p-2 rounded-full hover:bg-gray-100 transition-colors"
          >
            <CartIcon count={cartCount} />
          </button>
        </div>
      </div>
      
      <div className="md:hidden px-4 pb-4">
        <SearchBar />
      </div>
    </header>
  );
};

export default Header;
EOL

cat > ecommerce-otel/frontend/components/layout/CartIcon.js <<'EOL'
import React from 'react';
import { FiShoppingCart } from 'react-icons/fi';

const CartIcon = ({ count = 0 }) => {
  return (
    <div className="relative">
      <FiShoppingCart className="text-2xl text-gray-700" />
      {count > 0 && (
        <span className="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">
          {count}
        </span>
      )}
    </div>
  );
};

export default CartIcon;
EOL

cat > ecommerce-otel/frontend/components/layout/Footer.js <<'EOL'
import Link from 'next/link';

const Footer = () => {
  return (
    <footer className="bg-gray-800 text-white py-12">
      <div className="container mx-auto px-4">
        <div className="grid grid-cols-1 md:grid-cols-4 gap-8">
          <div>
            <h3 className="text-xl font-bold mb-4">ShopNext</h3>
            <p className="text-gray-400">
              Your one-stop shop for all your needs. Quality products at affordable prices.
            </p>
          </div>
          
          <div>
            <h4 className="text-lg font-semibold mb-4">Shop</h4>
            <ul className="space-y-2 text-gray-400">
              <li><Link href="/products"><a className="hover:text-white">All Products</a></Link></li>
              <li><Link href="/products?category=electronics"><a className="hover:text-white">Electronics</a></Link></li>
              <li><Link href="/products?category=clothing"><a className="hover:text-white">Clothing</a></Link></li>
              <li><Link href="/products?category=home"><a className="hover:text-white">Home & Garden</a></Link></li>
            </ul>
          </div>
          
          <div>
            <h4 className="text-lg font-semibold mb-4">Customer Service</h4>
            <ul className="space-y-2 text-gray-400">
              <li><Link href="/contact"><a className="hover:text-white">Contact Us</a></Link></li>
              <li><Link href="/faq"><a className="hover:text-white">FAQs</a></Link></li>
              <li><Link href="/shipping"><a className="hover:text-white">Shipping Policy</a></Link></li>
              <li><Link href="/returns"><a className="hover:text-white">Returns & Exchanges</a></Link></li>
            </ul>
          </div>
          
          <div>
            <h4 className="text-lg font-semibold mb-4">Stay Connected</h4>
            <p className="text-gray-400 mb-4">
              Subscribe to our newsletter for the latest updates and offers.
            </p>
            <div className="flex">
              <input 
                type="email" 
                placeholder="Your email" 
                className="px-4 py-2 rounded-l-md w-full text-gray-800"
              />
              <button className="bg-indigo-600 px-4 py-2 rounded-r-md">
                Subscribe
              </button>
            </div>
          </div>
        </div>
        
        <div className="border-t border-gray-700 mt-8 pt-8 text-center text-gray-400">
          <p>Â© 2023 ShopNext. All rights reserved.</p>
        </div>
      </div>
    </footer>
  );
};

export default Footer;
EOL

# Create product components
cat > ecommerce-otel/frontend/components/product/ProductCard.js <<'EOL'
import Link from 'next/link';
import RatingStars from '../ui/RatingStars';
import { useCart } from '../../lib/cart';

const ProductCard = ({ product }) => {
  const { addToCart } = useCart();
  
  const handleAddToCart = (e) => {
    e.preventDefault();
    e.stopPropagation();
    addToCart({
      ...product,
      quantity: 1,
      size: product.sizes?.[0] || 'One Size'
    });
  };

  return (
    <Link href={`/products/${product.slug}`}>
      <a className="group block overflow-hidden transition-transform hover:scale-[1.02] shadow-md rounded-lg">
        <div className="relative">
          <div className="aspect-square bg-gray-100 rounded-t-lg overflow-hidden">
            {product.image ? (
              <img 
                src={product.image} 
                alt={product.name} 
                className="w-full h-full object-cover transition-transform group-hover:scale-105"
              />
            ) : (
              <div className="w-full h-full bg-gray-200 border-2 border-dashed rounded-xl flex items-center justify-center text-gray-400">
                <svg xmlns="http://www.w3.org/2000/svg" className="h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
              </div>
            )}
          </div>
          
          <button 
            onClick={handleAddToCart}
            className="absolute bottom-4 right-4 bg-white rounded-full p-2 shadow-md opacity-0 group-hover:opacity-100 transition-opacity hover:bg-indigo-50"
            aria-label="Add to cart"
          >
            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
              <path d="M3 1a1 1 0 000 2h1.22l.305 1.222a.997.997 0 00.01.042l1.358 5.43-.893.892C3.74 11.846 4.632 14 6.414 14H15a1 1 0 000-2H6.414l1-1H14a1 1 0 00.894-.553l3-6A1 1 0 0017 3H6.28l-.31-1.243A1 1 0 005 1H3zM16 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM6.5 18a1.5 1.5 0 100-3 1.5 1.5 0 000 3z" />
            </svg>
          </button>
          
          {product.onSale && (
            <div className="absolute top-4 left-4 bg-red-500 text-white text-xs font-bold px-2 py-1 rounded">
              SALE
            </div>
          )}
        </div>
        
        <div className="p-4 bg-white rounded-b-lg">
          <h3 className="font-semibold text-lg mb-1 group-hover:text-indigo-600">{product.name}</h3>
          <div className="flex items-center mb-2">
            <RatingStars rating={product.rating} />
            <span className="ml-2 text-gray-600 text-sm">({product.reviewCount})</span>
          </div>
          
          <div className="flex items-center gap-2">
            <span className="font-semibold">${product.price.toFixed(2)}</span>
            {product.originalPrice && (
              <span className="text-gray-500 text-sm line-through">${product.originalPrice.toFixed(2)}</span>
            )}
          </div>
        </div>
      </a>
    </Link>
  );
};

export default ProductCard;
EOL

# Create UI components
cat > ecommerce-otel/frontend/components/ui/RatingStars.js <<'EOL'
const RatingStars = ({ rating, max = 5 }) => {
  const fullStars = Math.floor(rating);
  const halfStar = rating % 1 >= 0.5;
  const emptyStars = max - fullStars - (halfStar ? 1 : 0);

  return (
    <div className="flex">
      {[...Array(fullStars)].map((_, i) => (
        <svg key={i} className="w-5 h-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
          <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
        </svg>
      ))}
      
      {halfStar && (
        <svg className="w-5 h-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
          <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
        </svg>
      )}
      
      {[...Array(emptyStars)].map((_, i) => (
        <svg key={i} className="w-5 h-5 text-gray-300" fill="currentColor" viewBox="0 0 20 20">
          <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
        </svg>
      ))}
    </div>
  );
};

export default RatingStars;
EOL

# Create LoadingSpinner component
cat > ecommerce-otel/frontend/components/ui/LoadingSpinner.js <<'EOL'
const LoadingSpinner = () => {
  return (
    <div className="flex justify-center items-center py-12">
      <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-indigo-500"></div>
    </div>
  );
};

export default LoadingSpinner;
EOL

# Create pages (FIXED CSS IMPORT)
cat > ecommerce-otel/frontend/pages/_app.js <<'EOL'
import { CartProvider } from '../lib/cart';
import Header from '../components/layout/Header';
import Footer from '../components/layout/Footer';
import CartDrawer from '../components/cart/CartDrawer';
import '/tailwind.css';
import '../styles/globals.css';

function MyApp({ Component, pageProps }) {
  return (
    <CartProvider>
      <div className="flex flex-col min-h-screen">
        <Header />
        <main className="flex-grow">
          <Component {...pageProps} />
        </main>
        <Footer />
        <CartDrawer />
      </div>
    </CartProvider>
  );
}

export default MyApp;
EOL

# Create homepage (FIXED SPAN CREATION)
cat > ecommerce-otel/frontend/pages/index.js <<'EOL'
import { useEffect, useState } from 'react';
import Link from 'next/link';
import ProductCard from '../components/product/ProductCard';
import LoadingSpinner from '../components/ui/LoadingSpinner';
import { fetchProducts } from '../lib/api';
import { trace } from '@opentelemetry/api';

export default function Home() {
  const [products, setProducts] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  useEffect(() => {
    const tracer = trace.getTracer('home-page');
    const span = tracer.startSpan('fetch-featured-products');
    
    fetchProducts()
      .then(data => {
        setProducts(data.slice(0, 8));
        setLoading(false);
        span.end();
      })
      .catch(err => {
        console.error(err);
        setError('Failed to load products. Please try again later.');
        setLoading(false);
        span.recordException(err);
        span.end();
      });
  }, []);

  if (loading) {
    return (
      <div className="container mx-auto px-4 py-12">
        <LoadingSpinner />
        <p className="text-center text-gray-600">Loading featured products...</p>
      </div>
    );
  }

  if (error) {
    return (
      <div className="container mx-auto px-4 py-12 text-center">
        <p className="text-red-500 mb-4">{error}</p>
        <button 
          onClick={() => window.location.reload()}
          className="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700"
        >
          Retry
        </button>
      </div>
    );
  }

  return (
    <div className="container mx-auto px-4 py-8">
      {/* Hero Section */}
      <section className="bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl p-8 mb-12 shadow-lg">
        <div className="max-w-2xl">
          <h1 className="text-4xl md:text-5xl font-bold mb-4">Summer Collection 2023</h1>
          <p className="text-xl mb-8">Discover our new arrivals and exclusive offers</p>
          <Link href="/products">
            <a className="inline-block bg-white text-indigo-600 font-semibold px-6 py-3 rounded-lg hover:bg-gray-100 transition-colors shadow-md">
              Shop Now
            </a>
          </Link>
        </div>
      </section>

      {/* Featured Products */}
      <section className="mb-16">
        <div className="flex justify-between items-center mb-8">
          <h2 className="text-3xl font-bold">Featured Products</h2>
          <Link href="/products">
            <a className="text-indigo-600 hover:text-indigo-800 font-medium flex items-center">
              View All Products
              <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 ml-1" viewBox="0 0 20 20" fill="currentColor">
                <path fillRule="evenodd" d="M10.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L12.586 11H5a1 1 0 110-2h7.586l-2.293-2.293a1 1 0 010-1.414z" clipRule="evenodd" />
              </svg>
            </a>
          </Link>
        </div>
        
        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
          {products.map(product => (
            <ProductCard key={product.id} product={product} />
          ))}
        </div>
      </section>

      {/* Categories */}
      <section className="mb-16">
        <h2 className="text-3xl font-bold mb-8">Shop by Category</h2>
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
          {['Electronics', 'Clothing', 'Home & Garden'].map((category, index) => (
            <Link key={category} href={`/products?category=${category.toLowerCase()}`}>
              <a className="group block">
                <div className="aspect-video bg-gray-200 rounded-xl overflow-hidden relative shadow-md transition-transform group-hover:scale-105">
                  <div className="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent group-hover:from-black/50 transition-all duration-300 flex items-end p-6">
                    <h3 className="text-2xl font-bold text-white">{category}</h3>
                  </div>
                </div>
              </a>
            </Link>
          ))}
        </div>
      </section>

      {/* Testimonials */}
      <section className="bg-gray-100 rounded-xl p-8 shadow-inner">
        <h2 className="text-3xl font-bold mb-8 text-center">What Our Customers Say</h2>
        <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
          {[
            {
              name: "Alex Johnson",
              text: "The quality of products exceeded my expectations. Fast shipping too!",
              rating: 5
            },
            {
              name: "Maria Garcia",
              text: "Excellent customer service. They helped me choose the perfect gift.",
              rating: 5
            },
            {
              name: "David Smith",
              text: "Great prices and a huge selection. Will definitely shop here again!",
              rating: 4
            }
          ].map((testimonial, index) => (
            <div key={index} className="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
              <div className="flex items-center mb-4">
                <div className="bg-gray-200 border-2 border-dashed rounded-xl w-16 h-16 mr-4" />
                <div>
                  <p className="font-semibold">{testimonial.name}</p>
                  <div className="flex">
                    {[...Array(5)].map((_, i) => (
                      <svg 
                        key={i} 
                        className={`w-5 w-5 ${i < testimonial.rating ? 'text-yellow-400' : 'text-gray-300'}`} 
                        fill="currentColor" 
                        viewBox="0 0 20 20"
                      >
                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                      </svg>
                    ))}
                  </div>
                </div>
              </div>
              <p className="text-gray-700 italic">"{testimonial.text}"</p>
            </div>
          ))}
        </div>
      </section>
    </div>
  );
}
EOL

# Create product listing page (FIXED SPAN CREATION)
cat > ecommerce-otel/frontend/pages/products/index.js <<'EOL'
import { useState, useEffect } from 'react';
import ProductCard from '../../components/product/ProductCard';
import FilterPanel from '../../components/search/FilterPanel';
import LoadingSpinner from '../../components/ui/LoadingSpinner';
import { fetchProducts } from '../../lib/api';
import { trace } from '@opentelemetry/api';

const ProductsPage = () => {
  const [products, setProducts] = useState([]);
  const [filteredProducts, setFilteredProducts] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [filters, setFilters] = useState({
    category: 'all',
    priceRange: [0, 1000],
    minRating: 0
  });

  useEffect(() => {
    const tracer = trace.getTracer('products-page');
    const span = tracer.startSpan('fetch-products');
    
    fetchProducts()
      .then(data => {
        setProducts(data);
        setFilteredProducts(data);
        setLoading(false);
        span.end();
      })
      .catch(err => {
        console.error(err);
        setError('Failed to load products. Please try again later.');
        setLoading(false);
        span.recordException(err);
        span.end();
      });
  }, []);

  useEffect(() => {
    applyFilters();
  }, [filters]);

  const applyFilters = () => {
    const filtered = products.filter(product => {
      return (
        (filters.category === 'all' || product.category === filters.category) &&
        product.price >= filters.priceRange[0] && 
        product.price <= filters.priceRange[1] &&
        product.rating >= filters.minRating
      );
    });
    setFilteredProducts(filtered);
  };

  if (loading) {
    return (
      <div className="container mx-auto px-4 py-12">
        <LoadingSpinner />
        <p className="text-center text-gray-600">Loading products...</p>
      </div>
    );
  }

  if (error) {
    return (
      <div className="container mx-auto px-4 py-12 text-center">
        <p className="text-red-500 mb-4">{error}</p>
        <button 
          onClick={() => window.location.reload()}
          className="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700"
        >
          Retry
        </button>
      </div>
    );
  }

  return (
    <div className="container mx-auto px-4 py-8">
      <h1 className="text-3xl font-bold mb-8">Shop Products</h1>
      
      <div className="flex flex-col md:flex-row gap-8">
        <div className="md:w-1/4">
          <FilterPanel filters={filters} setFilters={setFilters} />
        </div>
        
        <div className="md:w-3/4">
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            {filteredProducts.map(product => (
              <ProductCard key={product.id} product={product} />
            ))}
          </div>
          
          {filteredProducts.length === 0 && (
            <div className="text-center py-12">
              <p className="text-xl">No products match your filters</p>
              <button 
                onClick={() => setFilters({
                  category: 'all',
                  priceRange: [0, 1000],
                  minRating: 0
                })}
                className="mt-4 bg-indigo-600 text-white px-4 py-2 rounded-md"
              >
                Reset Filters
              </button>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

export default ProductsPage;
EOL

# Create cart components
cat > ecommerce-otel/frontend/components/cart/CartDrawer.js <<'EOL'
import { useCart } from '../../lib/cart';
import CartItem from './CartItem';
import Link from 'next/link';

const CartDrawer = () => {
  const { cart, isCartOpen, setIsCartOpen, cartCount, cartTotal, removeItem, updateQuantity } = useCart();

  if (!isCartOpen) return null;

  return (
    <div className="fixed inset-0 z-50">
      <div 
        className="absolute inset-0 bg-black bg-opacity-50"
        onClick={() => setIsCartOpen(false)}
      />
      
      <div className="absolute right-0 top-0 h-full w-full max-w-md bg-white shadow-xl flex flex-col transform transition-transform duration-300">
        <div className="p-4 border-b">
          <div className="flex justify-between items-center">
            <h2 className="text-xl font-bold">Your Cart ({cartCount})</h2>
            <button 
              onClick={() => setIsCartOpen(false)} 
              className="text-gray-500 hover:text-gray-700"
            >
              <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
        </div>
        
        <div className="flex-grow overflow-y-auto p-4">
          {cartCount === 0 ? (
            <div className="text-center py-12">
              <svg xmlns="http://www.w3.org/2000/svg" className="h-16 w-16 mx-auto text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
              </svg>
              <p className="mt-4 text-gray-600">Your cart is empty</p>
              <button 
                onClick={() => setIsCartOpen(false)}
                className="mt-6 bg-indigo-600 text-white px-6 py-2 rounded-md hover:bg-indigo-700 transition-colors"
              >
                Continue Shopping
              </button>
            </div>
          ) : (
            <>
              <div className="space-y-4">
                {cart.map(item => (
                  <CartItem 
                    key={`${item.id}-${item.size}`} 
                    item={item} 
                    onRemove={() => removeItem(item.id, item.size)}
                    onUpdateQuantity={(qty) => updateQuantity(item.id, item.size, qty)}
                  />
                ))}
              </div>
              
              <div className="mt-8 border-t pt-6">
                <div className="flex justify-between text-lg font-semibold mb-4">
                  <span>Subtotal:</span>
                  <span>${cartTotal.toFixed(2)}</span>
                </div>
                <p className="text-gray-600 text-sm mb-6">
                  Shipping and taxes calculated at checkout.
                </p>
                <Link href="/checkout">
                  <a className="block w-full bg-indigo-600 text-white py-3 rounded-md hover:bg-indigo-700 text-center transition-colors">
                    Proceed to Checkout
                  </a>
                </Link>
                <button 
                  onClick={() => setIsCartOpen(false)}
                  className="w-full mt-3 border border-gray-300 text-gray-700 py-3 rounded-md hover:bg-gray-50 transition-colors"
                >
                  Continue Shopping
                </button>
              </div>
            </>
          )}
        </div>
      </div>
    </div>
  );
};

export default CartDrawer;
EOL

cat > ecommerce-otel/frontend/components/cart/CartItem.js <<'EOL'
const CartItem = ({ item, onRemove, onUpdateQuantity }) => {
  return (
    <div className="flex items-center gap-4 py-4 border-b">
      <div className="w-20 h-20 bg-gray-100 rounded-md overflow-hidden flex-shrink-0">
        {item.image ? (
          <img 
            src={item.image} 
            alt={item.name} 
            className="w-full h-full object-cover"
          />
        ) : (
          <div className="w-full h-full bg-gray-200 border-2 border-dashed rounded-xl flex items-center justify-center text-gray-400">
            <svg xmlns="http://www.w3.org/2000/svg" className="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
          </div>
        )}
      </div>
      
      <div className="flex-grow">
        <h3 className="font-medium text-gray-800">{item.name}</h3>
        {item.size && <p className="text-gray-600 text-sm mt-1">Size: {item.size}</p>}
        <p className="font-semibold text-indigo-600 mt-1">${item.price.toFixed(2)}</p>
        
        <div className="flex items-center mt-3">
          <div className="flex border rounded-md">
            <button 
              onClick={() => onUpdateQuantity(item.quantity - 1)}
              className="px-3 py-1 bg-gray-100 hover:bg-gray-200 text-gray-600"
            >
              -
            </button>
            <span className="px-3 py-1 bg-white w-10 text-center">{item.quantity}</span>
            <button 
              onClick={() => onUpdateQuantity(item.quantity + 1)}
              className="px-3 py-1 bg-gray-100 hover:bg-gray-200 text-gray-600"
            >
              +
            </button>
          </div>
          <button 
            onClick={onRemove}
            className="ml-4 text-red-600 hover:text-red-800 text-sm flex items-center"
          >
            <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
            Remove
          </button>
        </div>
      </div>
    </div>
  );
};

export default CartItem;
EOL

# Create search components
cat > ecommerce-otel/frontend/components/search/FilterPanel.js <<'EOL'
const FilterPanel = ({ filters, setFilters }) => {
  const categories = ['electronics', 'clothing', 'home', 'accessories'];
  
  return (
    <div className="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
      <h3 className="text-lg font-semibold mb-6 pb-2 border-b">Filters</h3>
      
      <div className="space-y-8">
        <div>
          <h4 className="font-medium mb-3 text-gray-700">Category</h4>
          <div className="space-y-3">
            <label className="flex items-center">
              <input
                type="radio"
                name="category"
                checked={filters.category === 'all'}
                onChange={() => setFilters({...filters, category: 'all'})}
                className="mr-3 h-4 w-4 text-indigo-600"
              />
              <span className="text-gray-600">All Categories</span>
            </label>
            
            {categories.map(category => (
              <label key={category} className="flex items-center">
                <input
                  type="radio"
                  name="category"
                  checked={filters.category === category}
                  onChange={() => setFilters({...filters, category})}
                  className="mr-3 h-4 w-4 text-indigo-600"
                />
                <span className="text-gray-600 capitalize">{category}</span>
              </label>
            ))}
          </div>
        </div>
        
        <div>
          <h4 className="font-medium mb-3 text-gray-700">Price Range</h4>
          <div className="space-y-4">
            <div className="px-2">
              <input
                type="range"
                min="0"
                max="1000"
                value={filters.priceRange[1]}
                onChange={(e) => setFilters({
                  ...filters,
                  priceRange: [filters.priceRange[0], parseInt(e.target.value)]
                })}
                className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
              />
            </div>
            <div className="flex justify-between text-sm text-gray-600">
              <span>$0</span>
              <span>${filters.priceRange[1]}</span>
            </div>
          </div>
        </div>
        
        <div>
          <h4 className="font-medium mb-3 text-gray-700">Minimum Rating</h4>
          <div className="space-y-3">
            {[4, 3, 2, 1, 0].map(rating => (
              <label key={rating} className="flex items-center">
                <input
                  type="radio"
                  name="rating"
                  checked={filters.minRating === rating}
                  onChange={() => setFilters({...filters, minRating: rating})}
                  className="mr-3 h-4 w-4 text-indigo-600"
                />
                <div className="flex">
                  {[...Array(5)].map((_, i) => (
                    <svg 
                      key={i} 
                      className={`w-4 h-4 ${i < rating ? 'text-yellow-400' : 'text-gray-300'}`} 
                      fill="currentColor" 
                      viewBox="0 0 20 20"
                    >
                      <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                    </svg>
                  ))}
                </div>
              </label>
            ))}
          </div>
        </div>
      </div>
      
      <button 
        onClick={() => setFilters({
          category: 'all',
          priceRange: [0, 1000],
          minRating: 0
        })}
        className="mt-8 w-full bg-gray-100 text-gray-700 py-2 rounded-md hover:bg-gray-200 transition-colors"
      >
        Reset Filters
      </button>
    </div>
  );
};

export default FilterPanel;
EOL

cat > ecommerce-otel/frontend/components/search/SearchBar.js <<'EOL'
import { useState } from 'react';
import { useRouter } from 'next/router';

const SearchBar = () => {
  const [query, setQuery] = useState('');
  const router = useRouter();

  const handleSearch = (e) => {
    e.preventDefault();
    if (query.trim()) {
      router.push(`/products?search=${encodeURIComponent(query.trim())}`);
    }
  };

  return (
    <form onSubmit={handleSearch} className="relative">
      <input
        type="text"
        placeholder="Search products..."
        value={query}
        onChange={(e) => setQuery(e.target.value)}
        className="w-full pl-4 pr-10 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent shadow-sm"
      />
      <button 
        type="submit"
        className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-indigo-600"
      >
        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
      </button>
    </form>
  );
};

export default SearchBar;
EOL

# =============================
# BACKEND FILES (FIXED)
# =============================

# Create backend requirements
cat > ecommerce-otel/backend/requirements.txt <<'EOL'
fastapi==0.100.1
uvicorn==0.23.2
sqlalchemy==2.0.20
psycopg2-binary==2.9.7
python-dotenv==1.0.0
opentelemetry-api==1.19.0
opentelemetry-sdk==1.19.0
opentelemetry-exporter-otlp-proto-http==1.19.0
opentelemetry-instrumentation-fastapi==0.41b0
opentelemetry-instrumentation-sqlalchemy==0.41b0
requests==2.31.0
EOL

# Create tracing setup
cat > ecommerce-otel/backend/otel.py <<'EOL'
from opentelemetry import trace
from opentelemetry.exporter.otlp.proto.http.trace_exporter import OTLPSpanExporter
from opentelemetry.sdk.trace import TracerProvider
from opentelemetry.sdk.trace.export import BatchSpanProcessor
from opentelemetry.sdk.resources import Resource
import os

def configure_tracing():
    resource = Resource(attributes={"service.name": "ecommerce-backend"})
    provider = TracerProvider(resource=resource)
    processor = BatchSpanProcessor(OTLPSpanExporter(
        endpoint=os.getenv("OTEL_EXPORTER_OTLP_ENDPOINT") + "/v1/traces"
    ))
    provider.add_span_processor(processor)
    trace.set_tracer_provider(provider)
EOL

# Create CORS setup
cat > ecommerce-otel/backend/cors.py <<'EOL'
from fastapi.middleware.cors import CORSMiddleware

def add_cors(app):
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
EOL

# Create main backend file (FIXED)
cat > ecommerce-otel/backend/main.py <<'EOL'
import os
from fastapi import FastAPI, HTTPException
from sqlalchemy import create_engine, Column, Integer, String, Float, Text
from sqlalchemy.orm import sessionmaker, declarative_base
from .otel import configure_tracing
from .cors import add_cors
from opentelemetry.instrumentation.fastapi import FastAPIInstrumentor
import logging

# Configure logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# Initialize tracing
configure_tracing()

app = FastAPI()

# Add CORS middleware immediately after app creation
add_cors(app)

# Instrument FastAPI
FastAPIInstrumentor.instrument_app(app)

# Database setup
DATABASE_URL = os.getenv("DATABASE_URL")
if not DATABASE_URL:
    logger.error("DATABASE_URL environment variable is not set")
    raise RuntimeError("DATABASE_URL environment variable is not set")

engine = create_engine(DATABASE_URL)
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)
Base = declarative_base()

# Database models
class Product(Base):
    __tablename__ = "products"
    
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String(100), nullable=False)
    slug = Column(String(100), unique=True, index=True)
    description = Column(Text)
    price = Column(Float, nullable=False)
    category = Column(String(50))
    image = Column(String(200))
    rating = Column(Float, default=0.0)
    review_count = Column(Integer, default=0)
    sizes = Column(String(100))

# Create tables (in production, use migrations instead)
try:
    Base.metadata.create_all(bind=engine)
    logger.info("Database tables created")
except Exception as e:
    logger.error(f"Error creating database tables: {e}")

@app.get("/")
def read_root():
    return {"message": "E-commerce API is running"}

@app.get("/api/products")
def get_products():
    db = SessionLocal()
    try:
        products = db.query(Product).all()
        return products
    except Exception as e:
        logger.error(f"Error fetching products: {e}")
        raise HTTPException(status_code=500, detail="Internal server error")
    finally:
        db.close()

@app.get("/api/products/{slug}")
def get_product(slug: str):
    db = SessionLocal()
    try:
        product = db.query(Product).filter(Product.slug == slug).first()
        if product is None:
            raise HTTPException(status_code=404, detail="Product not found")
        return product
    except Exception as e:
        logger.error(f"Error fetching product {slug}: {e}")
        raise HTTPException(status_code=500, detail="Internal server error")
    finally:
        db.close()

@app.post("/api/cart")
def add_to_cart(item: dict):
    # In a real application, this would update the database
    # For this demo, we'll just log and return success
    logger.info(f"Item added to cart: {item}")
    return {"status": "success", "message": "Item added to cart"}

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8000)
EOL

# Create Dockerfile for frontend (FIXED)
cat > ecommerce-otel/frontend/Dockerfile <<'EOL'
FROM node:18-alpine AS deps
WORKDIR /app
COPY package*.json ./
RUN npm install

FROM node:18-alpine AS builder
WORKDIR /app
COPY --from=deps /app/node_modules ./node_modules
COPY . .
RUN npm run build
RUN npm run css:build

FROM node:18-alpine AS runner
WORKDIR /app
ENV NODE_ENV production
RUN addgroup -g 1001 -S nodejs
RUN adduser -S nextjs -u 1001
COPY --from=builder /app/public ./public
COPY --from=builder /app/.next/standalone ./
COPY --from=builder /app/.next/static ./.next/static
COPY --from=builder /app/public/tailwind.css ./public/
USER nextjs
EXPOSE 3000
CMD ["node", "server.js"]
EOL

# Create Dockerfile for backend (FIXED)
cat > ecommerce-otel/backend/Dockerfile <<'EOL'
FROM python:3.10-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

# Set execute permissions
RUN chmod +x ./wait-for-it.sh ./scripts/init_db.sh

CMD ["./wait-for-it.sh", "postgres:5432", "--", "sh", "-c", "./scripts/init_db.sh && uvicorn main:app --host 0.0.0.0 --port 8000"]
EOL

# Create README
cat > ecommerce-otel/README.md <<'EOL'
# E-commerce with Full-Stack Observability

## Fixed Issues:
1. Port 4317/4318 now properly exposed for OTLP
2. Prometheus metrics available at :8889/metrics
3. Frontend styling fixed with Tailwind CSS
4. Service health checks added
5. Startup sequencing with wait-for-it script
6. Tracing configuration fixed
7. CORS middleware properly applied
8. API error handling improved

## Services:
- Frontend: http://localhost:3000
- Backend API: http://localhost:8000
- Jaeger: http://localhost:16686
- Prometheus: http://localhost:9090
- Grafana: http://localhost:3001

## To start:
```bash
docker-compose up --build

EOL